<!DOCTYPE html>
<html dir="rtl" lang="ar">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
 <title>فيسبوك | متجر قصي</title>
  <link rel="icon" href="https://i.ibb.co/zHC1tQ8b/1757362837638.png" type="image/png">

  <!-- حارس مبكر: منع فتح الصفحة مباشرةً فقط (بدون الاعتماد على كاش الحالات) -->
  <script>
    (function(){
      try{
        var base = (location.pathname.split('/').pop() || '');
        var page = base.replace(/\.html$/,'');
        var redirectTo = 'index.html';

        // امنع الدخول المباشر إن لم يكن من داخل الموقع
        var nav = (performance.getEntriesByType && performance.getEntriesByType('navigation')) || [];
        var type = nav[0] ? nav[0].type : (performance.navigation ? (performance.navigation.type === 1 ? 'reload' : (performance.navigation.type === 2 ? 'back_forward' : '')) : '');
        var isReload = type === 'reload';
        var isBF = type === 'back_forward';
        var fromHome = false; try{ fromHome = sessionStorage.getItem('nav:fromHome') === '1'; }catch(_){ }
        var refOk = false; try{ var rr=document.referrer; if(rr){ var uu=new URL(rr); refOk=(uu.origin===location.origin);} }catch(_){ }
        var paramsAllow = false; try{ paramsAllow=(new URLSearchParams(location.search)).has('allow'); }catch(_){ }
        var guardOff = false; try{ guardOff=localStorage.getItem('nav:guardOff')==='1'; }catch(_){ }

        if (!fromHome && !isReload && !isBF && !refOk && !paramsAllow && !guardOff){
          try{ sessionStorage.setItem('nav:redirectedFrom', base); }catch(_){ }
          return window.location.replace(redirectTo);
        }
        if (fromHome){ try{ sessionStorage.removeItem('nav:fromHome'); }catch(_){} }
      }catch(e){ window.location.replace('index.html'); }
    })();
  </script>

  <!-- تهيئة الثيم مبكرًا وتعيين color-scheme -->
  <script>
    (function(){
      var theme = 'dark';
      try{ var t = localStorage.getItem('theme'); if(!t){ t = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)?'dark':'light'; } theme = (t==='light')?'light':'dark'; }catch(e){ theme='dark'; }
      document.documentElement.setAttribute('data-theme', theme);
      try{
        var metaCS=document.querySelector('meta[name="color-scheme"]'); if(!metaCS){ metaCS=document.createElement('meta'); metaCS.name='color-scheme'; document.head.appendChild(metaCS);} metaCS.setAttribute('content', theme==='dark'?'dark light':'light dark');
        var metaTC=document.querySelector('meta[name="theme-color"]'); if(!metaTC){ metaTC=document.createElement('meta'); metaTC.name='theme-color'; document.head.appendChild(metaTC);} metaTC.setAttribute('content', theme==='dark'?'#0b1220':'#f9f9f9');
      }catch(e){}
      var s=document.createElement('style'); s.id='critical-theme'; s.textContent='html{background:'+(theme==='dark'?'#0b1220':'#f9f9f9')+';color:'+(theme==='dark'?'#e6edf3':'#333')+'} body{background:inherit;color:inherit;margin:0}'; document.head.appendChild(s);
    })();
  </script>
  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0b1220">

  <!-- تحسين الاتصال المسبق -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://i.ibb.co" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <!-- تحميل مسبق لصورة العروض المتكررة -->

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <script>
  (function(){
    function applyCardState(card, state){
      var finalState = (state == null) ? 'on' : state;
      var titleEl = card.querySelector ? card.querySelector('h2') : null;
      var img = card.querySelector ? card.querySelector('img') : null;
      try{ card.classList.remove('loading'); }catch(_){ }
      if (finalState === 'off'){
        if (img){ try{ img.setAttribute('loading','eager'); img.setAttribute('decoding','sync'); img.setAttribute('fetchpriority','high'); }catch(_){ } }
        try{ card.classList.add('maintenance'); card.classList.remove('pending-state'); }catch(_){ }
        try{ card.removeAttribute('href'); }catch(_){ }
        if (titleEl){ try{ titleEl.textContent = '🚧 مغلق للصيانة'; }catch(_){ } }
      } else {
        try{
          if (card.dataset && card.dataset.originalHref){ card.setAttribute('href', card.dataset.originalHref); }
          card.classList.remove('maintenance','pending-state');
          if (titleEl && card.dataset && card.dataset.originalTitle){ titleEl.textContent = card.dataset.originalTitle; }
        }catch(_){ }
      }
    }
    function prepCard(card){
      try{
        if (!card.dataset.originalHref){ var href = card.getAttribute('href'); if (href) card.dataset.originalHref = href; }
        var t = card.querySelector && card.querySelector('h2');
        if (t && !card.dataset.originalTitle){ card.dataset.originalTitle = t.textContent || ''; }
      }catch(_){ }
    }
    function getPageNameFromCard(card){
      try{
        var href = (card.dataset && card.dataset.originalHref) || card.getAttribute('href') || '';
        href = href.split('?')[0].split('#')[0];
        return href.replace(/\.html$/,'');
      }catch(_){ return ''; }
    }
    var STATES_TTL_MS = 5*60*1000;
    var STATES_CACHE_KEY = 'statesCache';
    function saveStatesCache(map){ try{ localStorage.setItem(STATES_CACHE_KEY, JSON.stringify({ savedAt: Date.now(), map: map||{} })); }catch(_){ } }
    function readStatesCache(ignoreTTL){
      try{
        var raw = localStorage.getItem(STATES_CACHE_KEY);
        if(!raw) return null;
        var obj; try{ obj = JSON.parse(raw); }catch(_){ obj=null; }
        if (obj && typeof obj === 'object'){
          if(!ignoreTTL){ var now = Date.now(); if(obj.savedAt && (now-obj.savedAt)>STATES_TTL_MS){ /* expired */ } }
          if (obj.map && typeof obj.map === 'object') return obj.map;
          if (typeof obj.stateJson === 'string'){ try{ var m=JSON.parse(obj.stateJson); if(m && typeof m==='object') return m; }catch(_){ } }
          var vals = Object.values(obj); if (vals.length && vals.every(function(v){return v==='on'||v==='off';})) return obj;
        }
        try{ var m2 = JSON.parse(raw); if (m2 && typeof m2==='object') return m2; }catch(_){ }
        return null;
      }catch(_){ return null; }
    }
    function parseStatesDoc(data){
      var map = {};
      try{
        if (typeof data.stateJson === 'string') { map = JSON.parse(data.stateJson)||{}; }
        else if (data.map && typeof data.map==='object'){ map = data.map; }
        else { map = data||{}; }
      }catch(_){ map = {}; }
      return map;
    }
    async function loadStatesMap(){
      try{
        if (typeof firebase==='undefined' || !firebase.firestore) return null;
        var ref = firebase.firestore().collection('config').doc('states');
        var snap = await ref.get({ source:'server' }).catch(function(){ return ref.get(); });
        if (!snap || !snap.exists) return null;
        var map = parseStatesDoc(snap.data()||{});
        saveStatesCache(map);
        return map;
      }catch(_){ return null; }
    }
    function applyStatesToPage(){
      try{
        var cards = Array.prototype.slice.call(document.querySelectorAll('a.card, .card[href]'));
        if (!cards.length) return;
        cards.forEach(prepCard);
        if (window.__SKIP_FIREBASE__){ try{ cards.forEach(function(card){ try{ card.removeAttribute('href'); card.classList.add('pending-state'); }catch(_){ } }); }catch(_){ } var cached = readStatesCache(true);
          if (cached){ cards.forEach(function(card){ var name=getPageNameFromCard(card); var s=(name && cached.hasOwnProperty(name))? cached[name] : 'on'; applyCardState(card,s); }); }
          return;
        }
        loadStatesMap().then(function(map){ if(!map){ map = readStatesCache(false)||{}; } cards.forEach(function(card){ var name=getPageNameFromCard(card); var s=(name && map && map.hasOwnProperty(name))? map[name] : 'on'; applyCardState(card,s); }); });
      }catch(_){ }
    }
    if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', applyStatesToPage); else try{ applyStatesToPage(); }catch(_){ }
  })();
  </script>
  
  <!-- تهيئة Firebase أولاً -->
  <script src="‏‏script1facebook.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js" async></script>
  <link href="style1.css" rel="stylesheet"/>
  <link href="header.css" rel="stylesheet"/>
  <script defer src="header.js"></script>
  <script defer src="atff.js"></script>
  <script defer src="script.js"></script>
  <link rel="stylesheet" href="loader.css">
  <script src="loader.js" defer></script>
  <audio id="toast-success-sound" preload="none" src="success.mp3"></audio>
  <audio id="toast-error-sound" preload="none" src="error.mp3"></audio>


  
  <style>
    /* متغيرات للألوان ليتوافق المودال مع الثيم */
    :root{ --card-bg:#ffffff; --card-text:#111827; --card-border:#e5e7eb; --input-bg:#ffffff; --input-text:#111827; --btn-bg:#6366f1; --btn-bg-hover:#4f46e5; --btn-text:#ffffff }
    html[data-theme="dark"], body.dark-mode{ --card-bg:#0f172a; --card-text:#e6edf3; --card-border:#334155; --input-bg:#0b1220; --input-text:#e6edf3; --btn-bg:#475569; --btn-bg-hover:#64748b; --btn-text:#ffffff }
    /* اتجاه عام مساعد */
    .rtl { direction: rtl; text-align: right; unicode-bidi: embed; }

    /* Modal theme-aware */
    #purchase-modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,23,42,0.28); -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px); z-index:10000 }
    #purchase-modal.show{ display:flex }
    #purchase-modal .pm-card{ width:min(560px,92vw); background:var(--card-bg); color:var(--card-text); border:1px solid var(--card-border); border-radius:18px; box-shadow:0 24px 70px rgba(0,0,0,.35); padding:22px 20px; direction:rtl }
    #purchase-modal .pm-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px }
    #purchase-modal .pm-pill{ background:var(--input-bg); color:var(--text); border-radius:999px; padding:8px 14px; font-weight:800; border:1px solid var(--card-border) }
    /* Make total look like input: equal size, rounded corners */
    #purchase-modal #pm-total.pm-pill{ display:block; width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--card-border); background:var(--input-bg); color:var(--input-text); text-align:center; font-size:16px; }
    #purchase-modal .pm-title{ font-weight:800; font-size:16px; display:flex; align-items:center; gap:8px }
    #purchase-modal .pm-input{ width:100%; margin:12px 0 6px }
    #purchase-modal .pm-input input{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--card-border); font-size:16px; outline:none; background:var(--input-bg); color:var(--input-text) }
    /* زر اللصق بجانب حقل الايدي داخل المودال */
    #purchase-modal .pm-input{ position: relative; }
    /* لم يعد هناك زر لصق؛ نعيد الحشو الافتراضي من القاعدة الأساسية */
    #purchase-modal .pm-paste{
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      inset-inline-end: 10px;
      background: var(--input-bg);
      color: var(--input-text);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 800;
    }
    #purchase-modal .pm-paste i{ pointer-events: none; }
    #purchase-modal .pm-paste:hover{ filter: brightness(0.98); }
    #purchase-modal .pm-actions{ display:flex; gap:12px; margin-top:12px }
    #purchase-modal .btn{ flex:1; padding:12px 16px; border-radius:14px; font-weight:800; cursor:pointer; border:1px solid transparent }
    #purchase-modal .btn-primary{ background:var(--btn-bg); color:var(--btn-text) }
    #purchase-modal .btn-primary:hover{ background:var(--btn-bg-hover) }
    #purchase-modal .btn-outline{ background:transparent; color:#ef4444; border-color:#ef4444 }
    #purchase-modal .pm-note{ margin-top:10px; font-size:14px; color:#16a34a; font-weight:700; text-align:center }

    /* عند فتح المودال أخفِ مظهر التحديد على الكروت (إزالة الصندوق/العلامة خلف المودال) */
    body.modal-open .offer-box.selected{ outline:none !important; border-color:transparent !important; box-shadow:none !important }
    body.modal-open .offer-box.selected::after{ display:none !important; content:none !important }

    /* صندوق الملخص */
    #selected-amount-container {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      text-align: center !important;
      margin:20px auto;max-width:400px;padding:20px;
      border:2px solid #007bff;border-radius:10px;background:#f9f9f9;font-weight:bold;
    }
    #selected-amount-container h2 { margin-bottom: 10px !important; }

    /* ✅ القسيمة RTL مع عزل الإنجليزية */
    #selected-amount-container .voucher{
      display:block !important;
      margin:0 auto !important;
      direction: rtl;
      text-align: right;
      unicode-bidi: isolate;
      font-weight: 700;
    }
    .voucher .line{ direction: rtl; text-align: right; margin: 10px 0; }
    .voucher .ltr{ direction: ltr; unicode-bidi: isolate; display:inline-block; white-space: nowrap; }
    .voucher .sep{ unicode-bidi: isolate; display:inline-block; padding: 0 .15rem; }
    .voucher .price{ white-space: nowrap; }

    /* شريط البحث + شبكة الكروت (مطابقة لطابع facebookinbut) */
    .search-container {
      max-width: 1100px;
      margin: 0 auto 24px auto;
      display: flex;
      justify-content: center;
    }
    .search-container input[type="text"]{
      flex:1;
      padding:12px 15px;
      background:#fff;
      color:#111;
      border:2px solid #0077cc;
      border-radius:25px;
      font-size:1rem;
      outline:none;
      transition:.3s;
      min-width: 0;
      width: 100%;
      max-width: 100%;
    }
    .search-container input[type="text"]:focus{box-shadow:0 0 6px rgba(0,119,204,.5);border-color:#005fa3}
    .search-container button{background:#0077cc;border:none;padding:12px 20px;border-radius:25px;color:#fff;font-size:1rem;cursor:pointer;transition:.3s}
    .search-container button:hover{background:#005fa3}

    /* نظام الشبكة والبطاقات مطابق للرئيسية index.html */
    .categories {
      display: grid;
      grid-template-columns: repeat(4, minmax(160px, 1fr));
      gap: 20px;
      justify-content: center;
      max-width: 1100px;
      margin: 0 auto;
    }
    @media (min-width: 1200px) {
      .search-container {
        max-width: 750px;
      }
      .categories {
        max-width: 1250px;
      }
    }
    @media (max-width: 992px) {
      .categories {
        grid-template-columns: repeat(3, minmax(140px, 1fr));
      }
    }
    @media (max-width: 600px) {
      .categories {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
      }
    }
    .offer-box.card, .card {
      background: var(--card-bg);
      color: var(--card-text);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      box-shadow: var(--elev-shadow);
      text-align: center;
      padding: 4px 4px 6px 4px;
      text-decoration: none;
      transition: transform .3s ease, box-shadow .3s ease;
      display: flex;
      flex-direction: column;
      gap: 0;
      min-width: 0;
      max-width: 200px;
      width: 100%;
      margin: 0 auto;
    }
    .offer-box.card:hover, .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,.15);
    }
    .offer-box.card h2, .card h2 {
      font-weight: 700;
      font-size: 1rem;
      margin: 0;
      line-height: 1;
      word-break: break-word;
    }
    .offer-box.card img, .card img {
      width: 100%;
      aspect-ratio: 1/1;
      height: auto;
      object-fit: cover;
      object-position: center;
      border-radius: 8px;
      user-select: none;
      background-color: var(--skeleton);
      display: block;
      margin: 0 auto;
    }
    /* سعر البطاقة أسفل الاسم */
/* السعر دائماً أبيض مع خلفية زرقاء خفيفة */
/* السعر صغير وواضح */
.offer-box .offer-price {
  font-size: 0.92em;
  font-weight: bold;
  color: #fff !important;
  margin: 0;
  letter-spacing: 0.5px;
  background: #0077cc;
  border-radius: 7px;
  padding: 0;
  width: 100%;
  display: block;
}
body.dark-mode .offer-box .offer-price {
  color: #fff !important;
  background: #0369a1;
}
    @media (max-width: 992px) {
      .categories {
        grid-template-columns: repeat(3, minmax(140px, 1fr));
        gap: 12px;
      }
      .offer-box.card, .card {
        max-width: 160px;
        padding: 12px !important;
      }
      .offer-box.card h2, .card h2 {
        font-size: .9rem !important;
      }
    }
    @media (max-width: 480px) {
      .categories {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 6px !important;
      }
      .offer-box.card, .card {
        max-width: 120px;
        padding: 6px !important;
      }
      .offer-box.card h2, .card h2 {
        font-size: .80rem !important;
      }
    }
    .offer-box.card{background:#fff;color:#111;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);text-align:center;padding:16px;text-decoration:none;transition:transform .3s ease,box-shadow .3s ease;display:flex;flex-direction:column;gap:12px}
    /* منع صعود البطاقة حتى لا تتداخل مع الصف الذي فوقها */
    .offer-box.card:hover{transform:none;box-shadow:0 8px 20px rgba(0,0,0,.15)}
    .offer-box.card h2{font-weight:700;font-size:1rem;margin:0;line-height:1.4;word-break:break-word}
    .offer-box.card .caption{margin-top:8px; line-height:1.35}
    .offer-box.card .caption .jewels{display:block; color:#475569; font-weight:700}
    .offer-box.card .caption .price{display:block; color:#0f172a; font-weight:800}
    .offer-box.card img{width:100%;aspect-ratio:1/1;height:auto;object-fit:cover;object-position:center;border-radius:8px;user-select:none;background-color:#f0f0f0;display:block;margin:0 auto}

    /* رسالة لا نتائج مثل الرئيسية */
    .no-results{ text-align:center; font-size:1.2rem; color:#888; margin-top:30px }
    body.dark-mode .no-results{ color:#94a3b8 }

    /* وضع داكن */
    body.dark-mode .search-container input[type="text"]{background:#0b1220;color:#e6edf3;border-color:#334155}
    body.dark-mode .search-container button{background:#475569}
    body.dark-mode .search-container button:hover{background:#64748b}
    body.dark-mode .offer-box.card{background:#101826;color:#e6edf3;border-color:#334155;box-shadow:0 2px 10px rgba(0,0,0,.35)}
    body.dark-mode .offer-box.card img{background:#162032}
    body.dark-mode .offer-box.card .caption .jewels{color:#cbd5e1}
    body.dark-mode .offer-box.card .caption .price{color:#e6edf3}

    /* البطاقات + تغطية "غير متوفر" */
    .offer-box { position: relative; cursor: pointer; }
    .offer-box.disabled { opacity: .4; cursor: not-allowed; }
    /* شارة غير متوفر صغيرة وواضحة */
    .offer-box .unavailable-badge{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35); color:#fff; font-weight:700; border-radius:12px;
      font-size: 0.93em;
      letter-spacing: 0.2px;
    }

/* ====== Dark Mode for Free Fire page ====== */
body.dark-mode{ background:#0b1220; color:#e6edf3; }

/* الصندوق الرئيسي */
body.dark-mode .main-white-box{
  background:#0f172a !important;
  color:#e6edf3 !important;
  border:1px solid #334155 !important;
  box-shadow:0 8px 22px rgba(0,0,0,.35);
}

/* صندوق مُعرّف اللاعب */
body.dark-mode .player-id-box{
  background:#0f172a !important;
  border-color:#334155 !important;
  color:#e6edf3 !important;
}
body.dark-mode .player-id-box label{ color:#e6edf3 !important; }
body.dark-mode .player-id-box input{
  background:#0b1220 !important;
  color:#e6edf3 !important;
  border-color:#334155 !important;
}

/* صندوق المبلغ المختار */
body.dark-mode #selected-amount-container{
  background:#0f172a !important;
  border-color:#334155 !important;
  color:#ffffff !important;
}
body.dark-mode #selected-amount-container .voucher,
body.dark-mode #selected-amount-container .voucher .line,
body.dark-mode #selected-amount-container .voucher .price{
  color:#ffffff !important;
}

/* بطاقات العروض */
body.dark-mode .offer-box{
  background:#101826 !important;
  border:1px solid #334155 !important;
  color:#e6edf3 !important;
}
body.dark-mode .offer-box span{ color:#e6edf3 !important; }
body.dark-mode .offer-box.selected{ outline:2px solid #38bdf8; }
    body.dark-mode .offer-box.disabled .unavailable-badge{ background:rgba(0,0,0,.45); }

/* عناوين الأقسام */
body.dark-mode .section-title{ color:#7dd3fc !important; }

/* زر الشراء */
body.dark-mode .send-button{
  background:#0369a1 !important;
  color:#e6edf3 !important;
}
body.dark-mode .send-button:hover{ background:#0ea5e9 !important; }

/* التوست */
body.dark-mode #toast{
  background:#0f172a !important;
  color:#e6edf3 !important;
}

/* النافذة المنبثقة (دليل المعرف) */
body.dark-mode #popup > div{
  background:#111827 !important;
  color:#e6edf3 !important;
}

/* محاكاة شيمر أخفت في الوضع الداكن إن وُجد */
body.dark-mode .offer-box.loading{ background:#162032 !important; }

/* === اجعل خلفية قسم لماذا تختارنا مثل الخلفيات الأخرى === */

/* وضع فاتح: لون مسطح مطابق لصناديق الصفحة */
.footer-icons{
  background: #f9f9f9 !important;  /* بديل للتدرّج */
  border: 1px solid #e0e6f7;        /* نفس حدود الصناديق الفاتحة */
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

/* تباين عنوان القسم على الخلفية الفاتحة */
.footer-title{
  color: #0b1220 !important;
}

/* وضع داكن: لون مسطح مطابق لصناديق الوضع الداكن */
body.dark-mode .footer-icons{
  background: #0f265a !important;   /* بديل للتدرّج الداكن */
  border-color: #334155;
  box-shadow: 0 8px 22px rgba(0,0,0,0.35);
}

/* نص العنوان في الوضع الداكن */
body.dark-mode .footer-title{
  color: #e6edf3 !important;
}


    /* استجابة للجوال */
    @media (max-width: 900px) {
      .categories {
        grid-template-columns: repeat(3, minmax(140px, 1fr)) !important;
        gap: 12px !important;
      }
      .offer-box.card {
        max-width: 160px;
        padding: 12px !important;
      }
    }
    /* أزل أي قواعد auto-fit للهواتف */

  
/* إزالة الأنماط التي كانت تُفرغ البطاقات والخلفيات لتطابق عرض index.html */
/* Note: السماح بقواعد .card الافتراضية (خلفية، حد، ظل، ورفع عند التحويم) */
/* 5 أعمدة ثابتة بدون تراكب (مطابقة الرئيسية) مع مسافة أفقية أكبر */
/* تم استبدال جميع قواعد الأعمدة بقواعد جديدة أعلاه */

/* حافظ على تأثير الرفع القياسي كالرئيسية */


/* === نفس سلوك البطاقات كما في الرئيسية (الإبقاء على تأثير الرفع فقط) === */

/* طبّق شكل البطاقة على عناصرك (.offer-box.card) لتطابق .card */
#myOffersContainer .offer-box.card,
.card{
  background: var(--card-bg) !important;
  color: var(--card-text) !important;
  border: 1px solid var(--card-border) !important;
  border-radius: 12px;
  box-shadow: var(--elev-shadow);
  text-align: center;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  transition: transform .3s ease, box-shadow .3s ease;
  position: relative;
  z-index: 0;
  overflow: hidden; /* يمنع بروز الصورة عند التحريك */
}

/* نفس الرفع على hover بدون أن تُغطّي بطاقة أخرى */
#myOffersContainer .offer-box.card:hover,
.card:hover{
  transform: none; /* لا تتحرك البطاقة نفسها لتجنب التداخل العمودي */
  box-shadow: 0 8px 20px rgba(0,0,0,.15);
  z-index: 1;
}

/* الصورة: نفس السلوك */
#myOffersContainer .offer-box.card img,
.card img{
  width: 100%;
  aspect-ratio: 1/1;
  height: auto;
  object-fit: cover;
  border-radius: 8px;
  background-color: var(--skeleton);
  transition: transform .45s ease, filter .35s ease;
  will-change: transform;
}
#myOffersContainer .offer-box.card:hover img,
.card:hover img{
  transform: scale(1.06) translateY(-2px);
  filter: saturate(1.08) contrast(1.05);
}

/* اجعل الشبكة تتحكم بعرض العناصر وليس قيم style1.css القديمة */
.offer-box.card{ width:auto !important; margin:0 !important; }

/* منع خروج المحتوى خارج حدود صندوق الحقول إن وجدت */
.offers-box{
  overflow: hidden;
  width: 100%;
  max-width: 600px;
  margin: 0 auto 24px auto;
  display: flex;
  flex-direction: column;
  align-items: center;
}
@media (min-width: 1200px) {
  .offers-box {
    max-width: 750px;
  }
}

/* نسخة auto (اختياري): نفس التنسيق الخاص والرفع الخفيف */
#myOffersContainer .offer-box.card.auto,
a.card.auto{
  border: 1.5px solid transparent;
  background:
    linear-gradient(var(--card-bg),var(--card-bg)) padding-box,
    linear-gradient(135deg,#06b6d4,#10b981) border-box;
}
html[data-theme="dark"] #myOffersContainer .offer-box.card.auto{
  background:
    linear-gradient(var(--card-bg),var(--card-bg)) padding-box,
    linear-gradient(135deg,#22c55e,#06b6d4) border-box;
}
#myOffersContainer .offer-box.card.auto:hover{
  transform: translateY(-4px) scale(1.01);
  box-shadow: 0 16px 36px rgba(0,0,0,.18), 0 0 28px rgba(250,204,21,.16);
}

/* استجابة للشاشات الصغيرة */
  /* إزالة أي قواعد متضاربة لعدد الأعمدة على الشاشات الصغيرة */
    @media (max-width: 768px) {
      .categories {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 10px !important;
      }
    }
    @media (max-width: 600px) {
      .categories {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
      }
    }
    @media (max-width: 480px) {
      .categories {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 6px !important;
      }
    }



</style> 

</head>
 <body>
  <div id="headerContainer"></div>
  <div id="sidebarContainer"></div>

  <div id="preloader">
  <div class="loader"></div>
</div>

<!-- تمت إزالة تكرار تضمين اللودر من أسفل الصفحة -->

  <!-- Toast (مرتين في ملفك الأصلي؛ نُبقي واحدًا فقط لتجنب التعارض) -->
  <div id="toast" style="
    visibility: hidden;
    min-width: 250px;
    margin-left: -125px;
    background-color: #323232;
    color: #fff;
    text-align: center;
    border-radius: 12px;
    padding: 16px;
    position: fixed;
    z-index: 9999;
    left: 50%;
    bottom: 30px;
    font-size: 16px;
    box-shadow: 0px 2px 10px rgba(0,0,0,0.2);
    transition: visibility 0s, opacity 0.5s ease-in-out;
    opacity: 0;">
    <span id="toast-message"></span>
  </div>

  <form id="orderForm" novalidate>
    <div class="container">

      

      <!-- نافذة الشراء المنبثقة -->
      <div id="purchase-modal">
        <div class="pm-card" role="dialog" aria-modal="true">
          <div class="pm-header">
            <span id="pm-price" class="pm-pill">—</span>
            <div class="pm-title">
              <i class="fa-regular fa-heart" aria-hidden="true"></i>
              <span id="pm-title">—</span>
            </div>
          </div>
          <div class="pm-input" style="display:flex; gap:10px; align-items:center;">
            <div style="flex:1;">
              <label for="qty-input" style="display:block;font-weight:800;margin:0 0 6px;">العدد</label>
              <input id="qty-input" type="number" inputmode="numeric" min="100" max="10000" step="1" value="100" aria-label="العدد" placeholder="اكتب الكمية" />
            </div>
            <div style="flex:1;">
              <label style="display:block;font-weight:800;margin:0 0 6px;">الاجمالي</label>
              <div id="pm-total" class="pm-pill">—</div>
            </div>
          </div>
          <div class="pm-input">
            <input id="player-id" type="url" autocomplete="off" aria-label="الرابط" autocapitalize="off" autocorrect="off" spellcheck="false" placeholder="الرابط" />
          </div>
          <div class="pm-actions">
            <button type="button" id="pm-cancel" class="btn btn-outline">إلغاء</button>
            <button type="button" id="pm-buy" class="btn btn-primary">شراء</button>
          </div>
          <div id="pm-qty-note" class="pm-note">يجب أن تكون الكمية أكبر من أو تساوي 100 وأصغر من 10000</div>
          
        </div>
      </div>

      

      
      <!-- شريط البحث (مطابق لـ facebookinbut) -->
      <div class="search-container">
        <input type="text" id="ffSearchInput" placeholder="ابحث عن الباقات..." aria-label="بحث" />
      </div>


        <div id="myOffersContainer"></div>

        
      </div>
    </div>

    <!-- رسالة لا نتائج مثل الرئيسية -->
    <p class="no-results" id="ffNoResults" style="display:none;">عذراً، لم يتم العثور على نتائج.</p>

    <div style="height: 40px;"></div>
    <div id="footerContainer"></div>
  </form>

  <script>


(function(){
  try{
    var saved = localStorage.getItem('theme');
    if(saved === 'dark'){
      document.body.classList.add('dark-mode');
    }
  }catch(e){}
})();
  // ===== Footer =====
  const footer = document.createElement("footer");
  footer.className = "footer-icons";
  const footerTitle = document.createElement("h2");
  footerTitle.className = "footer-title";
  footerTitle.textContent = "لماذا تختارنا؟";
  footer.appendChild(footerTitle);
  const iconBoxesData = [
    { iconClass: "fas fa-shipping-fast shipping-icon", title: "شحن سريع", desc: "يتميز متجرنا بسرعته الفائقة بالشحن فبمجرد أن تطلب سيتم الشحن لك مباشرة" },
    { iconClass: "fas fa-lock", title: "آمن 100%", desc: "حماية كاملة للبيانات والمعاملات" },
    { iconClass: "fas fa-headset", title: "دعم فني مستمر", desc: "دعم فني مستمر لمساعدة العملاء عند الحاجة" },
    { iconClass: "fas fa-coins special-icon", title: "اسعار مميزة", desc: "نقدم اسعار اقل من اسعار اللعبة" },
    { iconClass: "fas fa-credit-card", title: "سهولة الدفع", desc: "طرق دفع عديدة" },
    { iconClass: "fas fa-shield-alt", title: "ضمان على الشحن", desc: "احصل على كامل المبلغ مع تعويض في حالة عدم وصول الشحنه" },
    { iconClass: "fas fa-sync-alt", title: "تحديثات مستمرة", desc: "نقوم بحل جميع المشاكل بشكل دوري" },
    { iconClass: "fas fa-tasks", title: "تعقب الطلبات", desc: "يمكنك رؤية حالة الطلبات الخاص بك من تبويب طلباتي" },
    { iconClass: "fas fa-undo", title: "الغاء الطلبات", desc: "يمكنك الغاء اي طلب قبل اتمام عملية الدفع عبر التواصل مع الدعم الفني" },
    { iconClass: "fas fa-server", title: "تخزين للطلبات", desc: "يتم وضع الطلبات في سيرفرات لعدم فقدانها تحت اي ضرف" }
  ];

  iconBoxesData.forEach(({ iconClass, title, desc }) => {
    const box = document.createElement("div");
    box.className = "icon-box";
    const icon = document.createElement("i"); icon.className = iconClass; box.appendChild(icon);
    const h3 = document.createElement("h3"); h3.textContent = title; box.appendChild(h3);
    const p = document.createElement("p"); p.textContent = desc; box.appendChild(p);
    footer.appendChild(box);
  });

  // ===== بطاقات العروض =====
  function createOfferBox({ type, jewels, offer, imgSrc, imgAlt }, pricesObj) {
      const div = document.createElement("div");
      div.className = "offer-box card";
      div.dataset.type = type;
      if (jewels) div.dataset.jewels = jewels;
      if (offer) div.dataset.offer = offer;
      div.onclick = function () { openPurchaseModal(this); };
      const img = document.createElement("img");
      img.src = imgSrc; img.alt = imgAlt;
      img.loading = 'lazy'; img.decoding = 'async'; img.setAttribute('fetchpriority','low');
      div.appendChild(img);
      const h2 = document.createElement("h2"); h2.textContent = jewels ? `${jewels} شهر` : offer; div.appendChild(h2);
      // إضافة السعر أسفل الاسم
      const priceDiv = document.createElement("div");
      priceDiv.className = "offer-price";
      let price = null;
      if (pricesObj) {
        const key = jewels ? `${jewels}_jewels` : offer;
        price = pricesObj[key] !== undefined ? pricesObj[key] : null;
      }
      priceDiv.textContent = price !== null ? `${Number(price).toFixed(2)} د.أ` : "—";
      div.appendChild(priceDiv);
      return div;
  }

  const offersBox = document.createElement("div"); offersBox.className = "offers-box";
  const grid = document.createElement("section"); grid.className = "categories"; offersBox.appendChild(grid);
  const topupOffers = [
  ];
  // حفظ آخر حالة للعروض
  let _lastOffersState = null;
  function renderOffers(pricesObj) {
    grid.innerHTML = "";
    topupOffers.forEach(offer => { grid.appendChild(createOfferBox({ type: "topup", jewels: offer.jewels, imgSrc: offer.imgSrc, imgAlt: offer.imgAlt }, pricesObj)); });
    membershipOffers.forEach(offer => { grid.appendChild(createOfferBox({ type: "membership", offer: offer.offer, imgSrc: offer.imgSrc, imgAlt: offer.imgAlt }, pricesObj)); });
    // بعد رسم البطاقات، أعد تطبيق حالة الإغلاق إذا كانت متوفرة
    if (_lastOffersState) {
      Object.entries(_lastOffersState.topup || {}).forEach(([jewels, status]) => {
        const card = grid.querySelector(`.offer-box[data-type="topup"][data-jewels="${jewels}"]`);
        if (card) {
          card.classList.toggle('disabled', status === 'off');
          card.style.opacity = status === 'off' ? '0.4' : '1';
          let badge = card.querySelector('.unavailable-badge');
          if (status === 'off') {
            if (!badge) {
              badge = document.createElement('div');
              badge.className = 'unavailable-badge';
              badge.textContent = 'غير متوفر';
              card.appendChild(badge);
            }
          } else if (badge) {
            badge.remove();
          }
        }
      });
      Object.entries(_lastOffersState.membership || {}).forEach(([offerName, status]) => {
        const card = grid.querySelector(`.offer-box[data-type="membership"][data-offer="${offerName}"]`);
        if (card) {
          card.classList.toggle('disabled', status === 'off');
          card.style.opacity = status === 'off' ? '0.4' : '1';
          let badge = card.querySelector('.unavailable-badge');
          if (status === 'off') {
            if (!badge) {
              badge = document.createElement('div');
              badge.className = 'unavailable-badge';
              badge.textContent = 'غير متوفر';
              card.appendChild(badge);
            }
          } else if (badge) {
            badge.remove();
          }
        }
      });
    }
    try { if (typeof window.__updateFacebookPriceMeta === 'function') window.__updateFacebookPriceMeta(null); } catch(_){}
  }

  const membershipOffersGrid = document.createElement("div");
  const membershipOffers = [
    { offer: 'متابعين فيسبوك', imgSrc: 'https://i.ibb.co/HJJy62Y/IMG-20250915-WA0005.jpg', imgAlt: 'متابعين فيسبوك' }
  ];

  // عند تحميل الصفحة، انتظر تحميل الأسعار ثم اعرض البطاقات
  function waitAndRenderOffers() {
    let tries = 0;
    function tryRender() {
      let pricesObj = null;
      try {
        const raw = JSON.parse(localStorage.getItem("offersPrices") || "{}") || {};
        pricesObj = raw.prices || raw;
      } catch {}
      if (pricesObj && Object.keys(pricesObj).length > 0) {
        renderOffers(pricesObj);
        try { if (typeof updatePurchaseModalPriceIfOpen === 'function') updatePurchaseModalPriceIfOpen(); } catch(_){}
      } else if (tries < 20) {
        tries++;
        setTimeout(tryRender, 200);
      } else {
        setTimeout(tryRender, 250);
      }
    }
    tryRender();
  }
  waitAndRenderOffers();

  // إعادة تحميل البطاقات تلقائياً عند تحديث الأسعار في localStorage
  window.addEventListener('storage', function(e){
    if (e.key === 'offersPrices') {
      let pricesObj = null;
      try {
        const raw = JSON.parse(e.newValue || "{}") || {};
        pricesObj = raw.prices || raw;
      } catch {}
      renderOffers(pricesObj);
      try { if (typeof updatePurchaseModalPriceIfOpen === 'function') updatePurchaseModalPriceIfOpen(); } catch(_){}
      if (typeof window.__updateFacebookPriceMeta === 'function') {
        try { window.__updateFacebookPriceMeta(e.newValue); } catch(_){ }
      }
    }
  });

  // دعم التحديث الفوري حتى في نفس التبويب (override setItem)
  (function(){
    const origSetItem = localStorage.setItem;
    localStorage.setItem = function(key, val){
      origSetItem.apply(this, arguments);
      if(key === 'offersPrices'){
        let pricesObj = null;
        try {
          const raw = JSON.parse(val || "{}") || {};
          pricesObj = raw.prices || raw;
        } catch {}
        renderOffers(pricesObj);
        try { if (typeof updatePurchaseModalPriceIfOpen === 'function') updatePurchaseModalPriceIfOpen(); } catch(_){}
        if (typeof window.__updateFacebookPriceMeta === 'function') {
          try { window.__updateFacebookPriceMeta(val); } catch(_){ }
        }
      }
    };
  })();

  window.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById("myOffersContainer");
    if (container) container.appendChild(offersBox);
    // البحث مثل inbut
    const input = document.getElementById('ffSearchInput');
    const btn = document.getElementById('ffSearchButton');
    const apply = () => filterCardsBySearch({ target: { value: input.value } });
    btn && btn.addEventListener('click', apply);
    input && input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); apply(); }});
    let t; input && input.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(apply,150); });
  });

  // ===== حساب السعر وعرضه =====
function toggleOffer(element) {
  if (element.classList.contains("disabled")) { 
    showToast("غير متوفر", "warning"); 
    return; 
  }

  // ✅ إلغاء تحديد جميع العروض الأخرى
  document.querySelectorAll('.offer-box.selected').forEach(el => {
    el.classList.remove('selected');
  });

  // ✅ تحديد العنصر الحالي فقط

  const selectedOffers = [{
    type: element.dataset.type,
    jewels: element.dataset.jewels || null,
    offerName: element.dataset.offer || null
  }];

  // ✅ قراءة الأسعار من localStorage
  const raw = JSON.parse(localStorage.getItem("offersPrices") || "{}");
  const offersPrices = raw.prices || raw;

  let total = 0; 
  const breakdownLines = [];
  const key = element.dataset.jewels ? `${element.dataset.jewels}_jewels` : element.dataset.offer;
  const price = offersPrices[key];
  if (price !== undefined) {
    total += Number(price);
const nameText  = element.dataset.jewels ? `${element.dataset.jewels} شهر` : element.dataset.offer;
const priceText = `${Number(price).toFixed(2)} د.أ`;
breakdownLines.push(
  `<span class="item-name">${nameText}</span> : <span class="item-price">${priceText}</span>`
);

  } else {
    breakdownLines.push(`• ${element.dataset.jewels || element.dataset.offer}: ❓ غير معروف`);
  }

const el = document.getElementById("selected-amount");

if (breakdownLines.length === 0) {
  // لا يوجد أي عنصر مختار
  el.textContent = "لم يتم اختيار عرض شحن";
  el.classList.add("no-selection");
} else 
  // يوجد عناصر مختارة
  el.innerHTML = `${breakdownLines.join("<br>")}<br><br><strong>المجموع: ${total.toFixed(2)} د.أ</strong>`;
  el.classList.remove("no-selection");
}

// فلترة البحث بنفس أسلوب facebookinbut + إظهار رسالة لا نتائج كالرئيسية
function filterCardsBySearch(ev){
  const raw = (ev.target.value || '').toString();
  const norm = s => s.toLowerCase()
    .replace(/[ًٌٍَُِّْـ]/g,'')
    .replace(/[إأآا]/g,'ا')
    .replace(/ى/g,'ي')
    .replace(/ة/g,'ه')
    .replace(/[^\p{L}\p{N}\s]/gu,'')
    .trim();
  const q = norm(raw);
  const cards = document.querySelectorAll('.offer-box.card');
  let shown = 0;
  if (!q){ cards.forEach(c => {c.style.display=''; shown++;}); } else {
    cards.forEach(c => {
      const jewels = (c.dataset.jewels || '').toString();
      const offer  = (c.dataset.offer  || '');
      const text   = norm(`${jewels} ${offer}`);
      const ok = text.includes(q);
      c.style.display = ok ? '' : 'none';
      if (ok) shown++;
    });
  }
  const noRes = document.getElementById('ffNoResults');
  if (noRes) noRes.style.display = shown ? 'none' : 'block';
}

// ===== نافذة الشراء =====
window._pm_currentCard = null;
function _readOfferPriceForElement(el){
  const raw = JSON.parse(localStorage.getItem("offersPrices") || "{}");
  const prices = raw.prices || raw || {};
  const key = el.dataset.jewels ? `${el.dataset.jewels}_jewels` : el.dataset.offer;
  const p = prices[key];
  const num = p !== undefined ? Number(p) : NaN;
  return { key, price: p, priceText: isNaN(num)? '—' : `${num.toFixed(2)} د.أ` }; 
}

  // تحديث سعر المودال لحظياً إن كان مفتوحاً عند وصول الأسعار
  function updatePurchaseModalPriceIfOpen(){
    try{
      const pm = document.getElementById('purchase-modal');
      if (!pm || !pm.classList.contains('show')) return;
      if (!window._pm_currentCard) return;
      const { priceText } = _readOfferPriceForElement(window._pm_currentCard);
      const priceEl = document.getElementById('pm-price');
      if (priceEl) priceEl.textContent = priceText || '—';
      const totalEl = document.getElementById('pm-total');
      if (totalEl) totalEl.textContent = priceText || '—';
    }catch(_){/* ignore */}
  }

  // مراقبة إغلاق البطاقة أثناء فتح النافذة
  let _pm_watchInterval = null;
  function openPurchaseModal(el){
    if (el.classList.contains('disabled')){
      showToast('غير متوفر', 'warning');
      closePurchaseModal();
      return;
    }
    // اجعل البطاقة المختارة هي فقط المحددة
    document.querySelectorAll('.offer-box.selected').forEach(x => x.classList.remove('selected'));
    el.classList.add('selected');
    window._pm_currentCard = el;
    const title = el.dataset.jewels ? `${el.dataset.jewels} شهر` : (el.dataset.offer || '—');
    const { priceText } = _readOfferPriceForElement(el);
    document.getElementById('pm-title').textContent = title;
    document.getElementById('pm-price').textContent = priceText;
      try {
        if (typeof window.__updateFacebookPriceMeta === 'function') {
          window.__updateFacebookPriceMeta(null);
        }
      } catch(_){}
    try { document.getElementById('pm-total').textContent = priceText; } catch(_){ }
    const pid  = document.getElementById('player-id');
    const mpid = document.getElementById('modal-player-id');
    if (pid && mpid) mpid.value = (pid.value || '').trim();
    const pm = document.getElementById('purchase-modal');
    try{
      const ts = document.getElementById('cf-turnstile-modal');
      if (ts){
        const isDark = document.body.classList.contains('dark-mode')
          || (document.documentElement.getAttribute('data-theme')||'').toLowerCase()==='dark';
        ts.setAttribute('data-theme', isDark ? 'dark' : 'light');
      }
    }catch(_){}
    pm.classList.add('show');
    document.body.classList.add('modal-open');
    // راقب حالة البطاقة المختارة وأغلق النافذة إذا أُغلقت البطاقة
    if (_pm_watchInterval) clearInterval(_pm_watchInterval);
    _pm_watchInterval = setInterval(function(){
      if (_pm_currentCard && _pm_currentCard.classList.contains('disabled')) {
        closePurchaseModal();
        showToast('غير متوفر', 'warning');
        clearInterval(_pm_watchInterval);
        _pm_watchInterval = null;
      }
    }, 400);
  }

  function closePurchaseModal(){
    const pm = document.getElementById('purchase-modal');
    pm.classList.remove('show');
    document.body.classList.remove('modal-open');
    document.querySelectorAll('.offer-box.selected').forEach(x => x.classList.remove('selected'));
    if (window._pm_watchInterval) {
      clearInterval(window._pm_watchInterval);
      window._pm_watchInterval = null;
    }
  }

// ربط أزرار المودال
window.addEventListener('DOMContentLoaded', () => {
  const pm = document.getElementById('purchase-modal');
  if (!pm) return;
  pm.addEventListener('click', (e)=>{ if(e.target === pm) closePurchaseModal(); });
  const cancelBtn = document.getElementById('pm-cancel');
  const buyBtn = document.getElementById('pm-buy');
  cancelBtn && cancelBtn.addEventListener('click', closePurchaseModal);
  buyBtn && buyBtn.addEventListener('click', async () => {
    // انقل الايدي
    const mpid = document.getElementById('modal-player-id');
    const pid = document.getElementById('player-id');
    if (pid && mpid) pid.value = mpid.value.trim();
    if (!_pm_currentCard){ showToast('الرجاء اختيار عرض', 'warning'); return; }
    // تحقق من صحة الكمية قبل الإرسال
    const qtyEl = document.getElementById('qty-input');
    const q = Number(qtyEl && qtyEl.value);
    if (!Number.isFinite(q) || q < 100 || q >= 10000) {
      showToast('الكمية يجب أن تكون أكبر من أو تساوي 100 وأصغر من 10000', 'warning');
      return;
    }
    // أرسل الطلب
    try { if (typeof sendOrder === 'function') await sendOrder(); }
    finally { closePurchaseModal(); }
  });
});



  // ===== Toast =====
  function showToast(message, type = "info", duration = 4000) {
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toast-message");
    if (!toast || !toastMessage) return;
    let icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
    toastMessage.innerHTML = `<span style="margin-right:8px;">${icon}</span>${message}`;
  toast.style.background = type === 'success' ? 'linear-gradient(135deg, #28a745, #218838)'
              : type === 'error'   ? 'linear-gradient(135deg, #dc3545, #b52a38)'
              : type === 'warning' ? 'linear-gradient(135deg, #ffc107, #e0a800)'
                         : 'linear-gradient(135deg, #17a2b8, #117a8b)';
  toast.style.color = '#fff'; toast.style.padding = '14px 20px'; toast.style.borderRadius = '10px';
  toast.style.fontSize = '16px'; toast.style.fontWeight = 'bold'; toast.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
  toast.style.display = 'flex'; toast.style.alignItems = 'center'; toast.style.gap = '10px';
  toast.style.justifyContent = 'center'; toast.style.textAlign = 'center';
  toast.style.transform = 'translateY(100px)'; toast.style.opacity = '0'; toast.style.visibility = 'visible'; toast.style.transition = 'all 0.5s ease';
    setTimeout(() => { toast.style.transform = 'translateY(0)'; toast.style.opacity = '1'; }, 50);
    setTimeout(() => { toast.style.transform = 'translateY(100px)'; toast.style.opacity = '0'; setTimeout(() => { toast.style.visibility = 'hidden'; }, 500); }, duration);
  }

  // زر لصق البريد الإلكتروني
  async function pastePlayerId(){
    try{
      const input = document.getElementById('player-id');
      if (!input) return;
      if (!navigator.clipboard || !navigator.clipboard.readText){
        showToast('المتصفح لا يسمح بالوصول للحافظة تلقائياً', 'warning');
        input.focus();
        return;
      }
      const text = await navigator.clipboard.readText();
      let val = (text || '').trim();
      const im = (input.getAttribute('inputmode')||'').toLowerCase();
      if (im.includes('numeric') || im.includes('tel')){
        val = val.replace(/\D+/g, '');
      }
      if (!val){
        showToast('لا يوجد نص في الحافظة', 'warning');
        return;
      }
      input.value = val;
      try{ input.dispatchEvent(new Event('input', {bubbles:true})); }catch(_){}
      input.focus();
      showToast('تم لصق البريد الإلكتروني', 'success');
    }catch(e){
      showToast('تعذر قراءة الحافظة. الصق يدوياً', 'warning');
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    const btn = document.getElementById('pm-paste');
    if (btn) btn.addEventListener('click', pastePlayerId);
  });

  // ===== منطق تسعير الكمية المتغيرة لفيسبوك =====
  (function setupDynamicFacebookQty(){
    const qtyEl = document.getElementById('qty-input');
    const totalEl = document.getElementById('pm-total');
    const bubbleEl = document.getElementById('pm-price');
    const noteEl = document.getElementById('pm-qty-note');

    const DEFAULT_LIMITS = Object.freeze({ min: 100, max: 9999, step: 1 });
    const originalNoteText = noteEl ? noteEl.textContent : '';

    let meta = null;
    let initialPriceApplied = false;
    function updateOfferCardPrice(text){
      const priceText = (typeof text === 'string' && text.trim()) ? text : '—';
      try {
        const activeCard = window._pm_currentCard;
        if (activeCard){
          const priceEl = activeCard.querySelector('.offer-price');
          if (priceEl) priceEl.textContent = priceText;
        }
      } catch(_){}
      try {
        const membershipCard = document.querySelector('.offer-box[data-type="membership"] .offer-price');
        if (membershipCard) membershipCard.textContent = priceText;
      } catch(_){}
    }


    function applyInitialPriceIfNeeded(info){
      if (initialPriceApplied || !qtyEl || !info) return;
      let desired = 100;
      const min = Number(info.min);
      if (Number.isFinite(min) && desired < min) desired = Math.round(min);
      const stepVal = Number(info.step);
      const safeStep = Number.isFinite(stepVal) && stepVal > 0 ? Math.round(stepVal) : 1;
      if (safeStep > 1){
        const remainder = desired % safeStep;
        if (remainder !== 0) desired += (safeStep - remainder);
      }
      qtyEl.value = String(desired);
      initialPriceApplied = true;
    }

    function parseOffersPayload(rawValue){
      if (rawValue == null) {
        rawValue = localStorage.getItem('offersPrices');
      }
      let parsed = {};
      if (typeof rawValue === 'string') {
        try { parsed = JSON.parse(rawValue || '{}') || {}; }
        catch (_) { parsed = {}; }
      } else if (rawValue && typeof rawValue === 'object') {
        parsed = rawValue;
      }
      const prices = (parsed && typeof parsed === 'object' && parsed.prices) ? parsed.prices : parsed;
      const metaData = (parsed && typeof parsed === 'object') ? (parsed.meta || null) : null;
      const level = (parsed && typeof parsed === 'object' && Object.prototype.hasOwnProperty.call(parsed, 'level')) ? parsed.level : null;
      return {
        prices: (prices && typeof prices === 'object') ? prices : {},
        meta: (metaData && typeof metaData === 'object') ? metaData : null,
        level
      };
    }

    function toNumber(value, fallback){
      const num = Number(value);
      return Number.isFinite(num) ? num : fallback;
    }

    function buildMetaFromSource(source){
      const prices = source.prices || {};
      const metaData = source.meta || {};
      const stepValue = Math.max(1, toNumber(metaData.step, DEFAULT_LIMITS.step));
      return {
        min: toNumber(metaData.min, DEFAULT_LIMITS.min),
        max: toNumber(metaData.max, DEFAULT_LIMITS.max),
        step: stepValue,
        unit: {
          per: toNumber(metaData.unit && metaData.unit.per, 0),
          price: toNumber(metaData.unit && metaData.unit.price, 0)
        },
        prices,
        level: source.level || null
      };
    }

    function setMetaFromRaw(rawValue){
      const parsed = parseOffersPayload(rawValue);
      if (!parsed.meta && (!parsed.prices || Object.keys(parsed.prices).length === 0)) {
        return meta;
      }
      meta = buildMetaFromSource(parsed);
      applyInitialPriceIfNeeded(meta);
      return meta;
    }

    function ensureMetaFromCache(){
      if (meta && meta.prices && Object.keys(meta.prices).length) {
        return meta;
      }
      return setMetaFromRaw(null);
    }

    function customRound(value){
      const num = Number(value);
      if (!Number.isFinite(num)) return null;
      const parts = num.toString().split('.');
      if (parts.length === 1) {
        return Number(num.toFixed(2));
      }
      const decimals = (parts[1] + '000').slice(0, 3);
      const thirdDigit = Number(decimals[2] || '0');
      let result = Math.floor(num * 100) / 100;
      if (thirdDigit >= 5) result += 0.01;
      return Number(result.toFixed(2));
    }

    function computePrice(tokens, info){
      if (!info) return null;
      const q = Number(tokens);
      if (!Number.isFinite(q)) return null;

      const { unit, prices, step } = info;
      const per = Number(unit && unit.per);
      const pricePer = Number(unit && unit.price);
      if (per > 0 && pricePer > 0){
        return customRound((q / per) * pricePer);
      }

      const priceMap = prices || {};
      const directKeys = [`${q}_tokens`, `topup:${q}`, String(q)];
      for (const key of directKeys){
        if (key in priceMap){
          const val = Number(priceMap[key]);
          if (Number.isFinite(val)) return customRound(val);
        }
      }

      const stepVal = Number(step);
      if (Number.isFinite(stepVal) && stepVal > 0){
        const baseKeys = [`${stepVal}_tokens`, `topup:${stepVal}`, String(stepVal)];
        for (const key of baseKeys){
          if (key in priceMap){
            const basePrice = Number(priceMap[key]);
            if (Number.isFinite(basePrice)){
              return customRound((q / stepVal) * basePrice);
            }
          }
        }
      }
      return null;
    }

    function formatCurrency(value){
      const num = Number(value);
      if (!Number.isFinite(num)) return '—';
      return num.toFixed(2) + ' د.أ';
    }

    function updateNote(info, isValid){
      if (!noteEl) return;
      const minAllowed = info ? info.min : DEFAULT_LIMITS.min;
      const maxAllowed = info ? info.max : DEFAULT_LIMITS.max;
      const stepAllowed = info ? info.step : DEFAULT_LIMITS.step;
      const minText = Math.round(minAllowed);
      const maxText = Math.round(maxAllowed);
      const stepText = Math.max(1, Math.round(stepAllowed));
      if (stepText > 1){
        noteEl.textContent = `يجب أن تكون الكمية بين ${minText} و ${maxText} وبمضاعفات ${stepText}`;
      } else if (originalNoteText){
        noteEl.textContent = originalNoteText;
      }
      noteEl.style.color = isValid ? '#16a34a' : '#ef4444';
    }

    function refreshQuote(){
      if (!qtyEl) return;
      const info = ensureMetaFromCache();
      const minAllowed = info ? info.min : DEFAULT_LIMITS.min;
      const maxAllowed = info ? info.max : DEFAULT_LIMITS.max;
      const stepAllowed = info ? info.step : DEFAULT_LIMITS.step;

      const q = Number(qtyEl.value);
      const intQty = Number.isInteger(q);
      const stepMismatch = intQty && stepAllowed > 1 ? (q % stepAllowed !== 0) : false;
      const invalid = !Number.isFinite(q) || q < minAllowed || q > maxAllowed || !intQty || stepMismatch;

      updateNote(info, !invalid);

      if (invalid){
        if (totalEl) totalEl.textContent = '—';
        if (bubbleEl) bubbleEl.textContent = '—';
        updateOfferCardPrice('—');
        return;
      }

      const total = computePrice(q, info);
      if (total != null){
        const txt = formatCurrency(total);
        if (totalEl) totalEl.textContent = txt;
        if (bubbleEl) bubbleEl.textContent = txt;
        updateOfferCardPrice(txt);
      } else {
        if (totalEl) totalEl.textContent = '—';
        if (bubbleEl) bubbleEl.textContent = '—';
        updateOfferCardPrice('—');
      }
    }
    window.__updateFacebookPriceMeta = function(rawValue){
      setMetaFromRaw(rawValue);
      refreshQuote();
    };

    const initialMeta = setMetaFromRaw(null);
    if (initialMeta && initialPriceApplied){
      refreshQuote();
    }

    if (qtyEl){
      qtyEl.addEventListener('input', () => { refreshQuote(); });
      setTimeout(refreshQuote, 50);
    }
  })();

  // ===== override: sendOrder (صفحة فيسبوك — كمية متغيرة) =====
  async function sendOrder(){
    const pidInput = document.getElementById('player-id');
    const qtyEl = document.getElementById('qty-input');
    const pid = pidInput ? (pidInput.value || '').trim() : '';
    const q = Number(qtyEl && qtyEl.value);
    if (!pid || !Number.isFinite(q) || q < 100 || q >= 10000){
      showToast('يرجى إدخال رابط صحيح واختيار كمية صحيحة', 'error');
      return;
    }

    const user = firebase.auth().currentUser;
    if (!user){ showToast('❌ يجب تسجيل الدخول أولاً', 'error'); showSessionExpiredModal(); return; }
    const sessionKey = (typeof getLocalSessionKey==='function') ? getLocalSessionKey() : '';
    if (!sessionKey){ showSessionExpiredModal(); return; }

    let authkey = null; let idToken = null;
    try {
      const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
      if (userDoc.exists) authkey = userDoc.data().authkey || null;
      idToken = await user.getIdToken(true);
    } catch { showToast('فشل التحقق من الحساب', 'error'); return; }

    const workerUrl = 'https://facebook.stwrqsy.workers.dev/';

    // Quote
    let total, breakdown;
    try{
      const r = await fetch(workerUrl + '/', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ offers: [{ type:'topup', tokens: q }], useruid: user.uid })
      });
      const j = await r.json();
      if (j?.success === false) throw new Error(j?.error || 'quote failed');
      total = j.total; breakdown = j.breakdown;
    }catch(e){ showToast('❌ فشل في حساب السعر', 'error'); return; }

    const submitBtn = document.getElementById('pm-buy');
    try{
      showPreloader && showPreloader();
      if (submitBtn){ submitBtn.disabled = true; submitBtn.dataset._oldText = submitBtn.textContent; submitBtn.textContent = 'جاري المعالجة...'; submitBtn.style.opacity='0.7'; submitBtn.style.pointerEvents='none'; }
      const resp = await fetch(workerUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}`, 'X-SessionKey': sessionKey },
        body: JSON.stringify({ playerId: pid, offers: [{ type:'topup', tokens: q }], currency: 'دأ', currentUrl: window.location.href, authkey })
      });
      if (resp.status === 401){
        let err = {}; try{ err = await resp.json(); }catch{}
        const code = (err?.code||'').toLowerCase();
        const sessionFail = code.startsWith('session_');
        if (sessionFail){ showSessionModal && showSessionModal('فشل التحقق من رمز الجلسة يرجى تسجيل الدخول مرة اخرى'); return; }
        showToast('فشل الشراء: ' + (err?.error||'Unknown'), 'error'); return;
      }
      const result = await resp.json();
      if (result?.success){
        showConfirmation && showConfirmation(result.orderCode);
        try{ rotateSessionKeyAfterOrder && rotateSessionKeyAfterOrder(user.uid); }catch{}
      } else {
        const code = (result?.code||'').toLowerCase();
        if (code.startsWith('session_')){ showSessionModal && showSessionModal('فشل التحقق من رمز الجلسة يرجى تسجيل الدخول مرة اخرى'); return; }
        showToast('فشل الشراء: ' + (result?.error||'خطأ غير معروف'), 'error');
      }
    } finally {
      hidePreloader && hidePreloader();
      if (submitBtn){ submitBtn.disabled = false; submitBtn.textContent = submitBtn.dataset._oldText || 'شراء'; submitBtn.style.opacity=''; submitBtn.style.pointerEvents=''; }
    }
  }

  // ===== تهيئة بطاقات التفعيل/التعطيل من Firestore =====
  firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
      const userDocRef = firebase.firestore().collection("users").doc(user.uid);
      const snap = await userDocRef.get();
      if (snap.exists) {
        const userData = snap.data();
        const nameInput = document.getElementById("userName");
        if (nameInput) {
          nameInput.value = userData.username || "";
          nameInput.readOnly = true;
          nameInput.style.backgroundColor = "#e9ecef";
          nameInput.style.cursor = "not-allowed";
        }
      }
    } else {
      location.href = "login.html";
    }
  });

  document.addEventListener("DOMContentLoaded", async () => {
    try {
      // جلب من topup > facebook والحقل state نص JSON
      const stateDoc = await firebase.firestore().collection("topup").doc("facebook").get();
      if (stateDoc.exists) {
        let stateData = stateDoc.data();
        if (stateData && typeof stateData.state === 'string') {
          try { stateData = JSON.parse(stateData.state); } catch(e) { stateData = {}; }
        }
        // احفظ آخر حالة للعروض
        _lastOffersState = stateData;
        Object.entries(stateData.topup || {}).forEach(([jewels, status]) => {
          const card = document.querySelector(`.offer-box[data-type=\"topup\"][data-jewels=\"${jewels}\"]`);
          if (card) {
            card.classList.toggle('disabled', status === 'off');
            card.style.opacity = status === 'off' ? '0.4' : '1';
            // أضف عبارة غير متوفر إذا كان مغلقاً
            let badge = card.querySelector('.unavailable-badge');
            if (status === 'off') {
              if (!badge) {
                badge = document.createElement('div');
                badge.className = 'unavailable-badge';
                badge.textContent = 'غير متوفر';
                card.appendChild(badge);
              }
            } else if (badge) {
              badge.remove();
            }
            // إذا كانت البطاقة المختارة أُغلقت أثناء فتح المودال، أغلق المودال
            if (window._pm_currentCard && window._pm_currentCard === card && status === 'off') {
              closePurchaseModal();
            }
          }
        });
        Object.entries(stateData.membership || {}).forEach(([offerName, status]) => {
          const card = document.querySelector(`.offer-box[data-type=\"membership\"][data-offer=\"${offerName}\"]`);
          if (card) {
            card.classList.toggle('disabled', status === 'off');
            card.style.opacity = status === 'off' ? '0.4' : '1';
            let badge = card.querySelector('.unavailable-badge');
            if (status === 'off') {
              if (!badge) {
                badge = document.createElement('div');
                badge.className = 'unavailable-badge';
                badge.textContent = 'غير متوفر';
                card.appendChild(badge);
              }
            } else if (badge) {
              badge.remove();
            }
            if (window._pm_currentCard && window._pm_currentCard === card && status === 'off') {
              closePurchaseModal();
            }
          }
        });
      } else {
        console.warn("⚠️ لم يتم العثور على وثيقة الحالة في Firestore (topup/facebook)");
      }
    } catch (e) { console.error("❌ فشل في جلب حالة العروض:", e); }
  });


  
  </script>
 <script>
// Gate: require login, and page state must be open in Firestore 'states'
(function(){
  function getPageId(){ try{ return (location.pathname.split('/').pop()||'').replace('.html',''); }catch(_){ return '' } }
  firebase.auth().onAuthStateChanged(async function(user){
    if(!user){ try{ location.href = 'login.html'; }catch(_){} return; }
    try{
      var pageId = getPageId();
      if(!pageId) return; // if unknown, allow
      var doc = await firebase.firestore().collection('states').doc(pageId).get();
      var st = doc && doc.exists ? (doc.data() && (doc.data().state || doc.data().status || 'on')) : 'on';
      if(String(st).toLowerCase() !== 'on'){
        // redirect back to games list if this card is closed
        try{ location.href = 'games.html'; }catch(_){}
      }
    }catch(e){ /* if check fails, allow to avoid blocking */ }
  });
})();
</script>
  
</body>
</html>
















