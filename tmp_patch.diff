*** Begin Patch
*** Update File: order.js
@@
-async function getOrderDetails(orderId, FIRESTORE, accessToken) {
-  const publicRes = await fetch(${FIRESTORE}/orders//public/main, {
-    headers: { Authorization: Bearer  }
-  });
-  const privateRes = await fetch(${FIRESTORE}/orders//private/main, {
-    headers: { Authorization: Bearer  }
-  });
-
-  const publicData = await publicRes.json();
-  const privateData = await privateRes.json();
-
-  if (!publicData.fields && !privateData.fields) {
-    return âŒ Ø§Ù„Ø·Ù„Ø¨ \${orderId}\ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.;
-  }
-
-  const title = publicData.fields?.title?.stringValue || "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯";
-  const playerId = publicData.fields?.playerId?.stringValue || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
-  const offer = publicData.fields?.["Ø§Ù„Ø¹Ø±ÙˆØ¶"]?.stringValue || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
-  const total = publicData.fields?.total?.doubleValue || publicData.fields?.total?.stringValue || "ØŸ";
-  const name = privateData.fields?.name?.stringValue || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
-  const balanceBefore = Number(privateData.fields?.balanceBefore?.doubleValue ?? privateData.fields?.balanceBefore?.integerValue ?? 0);
-  const balanceAfter = Number(privateData.fields?.balanceAfter?.doubleValue ?? privateData.fields?.balanceAfter?.integerValue ?? 0);
-  const whatsapp = privateData.fields?.whatsapp?.stringValue || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
-  const whatsappLink = privateData.fields?.whatsappLink?.stringValue || https://wa.me/;
-  const webuid = privateData.fields?.webuid?.stringValue || "ØŸ";
-  const statusRaw = publicData.fields?.status?.stringValue || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
-  const statusHuman = typeof statusRaw === "string" ? statusRaw.replace(/_/g, " ") : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
-  
-  return ğŸ”” **\n\n\nğŸ“¦ *Ø§Ù„Ø­Ø§Ù„Ø©:*   \n\n\u200FğŸ†” *ÙƒÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨:* \${orderId}\\n  \nğŸ® *Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨:* \${playerId}\\n  \nğŸ *Ø§Ù„Ø¹Ø±ÙˆØ¶:*\n\n  \nğŸ‘¤ *Ø§Ù„Ø§Ø³Ù…:* \n  \nğŸ’° *Ø§Ù„Ø±ØµÙŠØ¯:*  â† \n  \nğŸ§¾ *Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„:* \${webuid}\\n  \nğŸ“± *ÙˆØ§ØªØ³Ø§Ø¨:* ;
-}
+// â€”â€”â€” Helpers for new orders path (orders/<uid>/byCode.<key>) â€”â€”â€”
+function orderKeyFromCode(orderCode) {
+  return String(orderCode || '').replace(/[^A-Za-z0-9_]/g, '_');
+}
+async function getOrderOwnerUid(FIRESTORE, accessToken, orderCode) {
+  try {
+    const res = await fetch(${FIRESTORE}/orderIndex/, { headers: { Authorization: Bearer  } });
+    if (!res.ok) return null;
+    const doc = await res.json();
+    return doc?.fields?.uid?.stringValue || null;
+  } catch { return null; }
+}
+async function fetchOrderEntry(FIRESTORE, accessToken, orderCode) {
+  const uid = await getOrderOwnerUid(FIRESTORE, accessToken, orderCode);
+  if (!uid) return { uid: null, entry: null };
+  const orderKey = orderKeyFromCode(orderCode);
+  const userDocUrl = ${FIRESTORE}/orders/;
+  const res = await fetch(userDocUrl, { headers: { Authorization: Bearer  } });
+  if (!res.ok) return { uid, entry: null };
+  const userDoc = await res.json();
+  const byCode = userDoc?.fields?.byCode?.mapValue?.fields || {};
+  const entry = byCode[orderKey]?.mapValue?.fields || null;
+  return { uid, entry };
+}
+
+async function getOrderDetails(orderId, FIRESTORE, accessToken) {
+  // Ø­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹
+  const { uid, entry } = await fetchOrderEntry(FIRESTORE, accessToken, orderId);
+  if (uid && entry) {
+    const pub = entry.public?.mapValue?.fields || {};
+    const priv = entry.private?.mapValue?.fields || {};
+    const title = pub.title?.stringValue || "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯";
+    const playerId = pub.playerId?.stringValue || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
+    const offer = pub["Ø§Ù„Ø¹Ø±ÙˆØ¶"]?.stringValue || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
+    const total = pub.total?.doubleValue ?? pub.total?.stringValue ?? "ØŸ";
+    const name = priv.name?.stringValue || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
+    const balanceBefore = Number(priv.balanceBefore?.doubleValue ?? priv.balanceBefore?.integerValue ?? 0);
+    const balanceAfter  = Number(priv.balanceAfter?.doubleValue  ?? priv.balanceAfter?.integerValue  ?? 0);
+    const whatsapp = priv.whatsapp?.stringValue || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
+    const whatsappLink = priv.whatsappLink?.stringValue || https://wa.me/;
+    const webuid = priv.webuid?.stringValue || "ØŸ";
+    const statusRaw = pub.status?.stringValue || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
+    const statusHuman = typeof statusRaw === "string" ? statusRaw.replace(/_/g, " ") : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
+
+    return ğŸ”” **\n\n\nğŸ“¦ *Ø§Ù„Ø­Ø§Ù„Ø©:*   \n\n\u200FğŸ†” *ÙƒÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨:* \${orderId}\\n  \nğŸ® *Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨:* \${playerId}\\n  \nğŸ *Ø§Ù„Ø¹Ø±ÙˆØ¶:*\n\n  \nğŸ‘¤ *Ø§Ù„Ø§Ø³Ù…:* \n  \nğŸ’° *Ø§Ù„Ø±ØµÙŠØ¯:*  â† \n  \nğŸ§¾ *Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„:* \${webuid}\\n  \nğŸ“± *ÙˆØ§ØªØ³Ø§Ø¨:* ;
+  }
+
+  // ØªÙˆØ§ÙÙ‚ÙŠÙ‹Ø§: Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
+  const publicRes = await fetch(${FIRESTORE}/orders//public/main, { headers: { Authorization: Bearer  } });
+  const privateRes = await fetch(${FIRESTORE}/orders//private/main, { headers: { Authorization: Bearer  } });
+  const publicData = await publicRes.json().catch(()=>({}));
+  const privateData = await privateRes.json().catch(()=>({}));
+  if (!publicData.fields && !privateData.fields) return âŒ Ø§Ù„Ø·Ù„Ø¨ \${orderId}\ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.;
+
+  const title = publicData.fields?.title?.stringValue || "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯";
+  const playerId = publicData.fields?.playerId?.stringValue || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
+  const offer = publicData.fields?.["Ø§Ù„Ø¹Ø±ÙˆØ¶"]?.stringValue || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
+  const total = publicData.fields?.total?.doubleValue || publicData.fields?.total?.stringValue || "ØŸ";
+  const name = privateData.fields?.name?.stringValue || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
+  const balanceBefore = Number(privateData.fields?.balanceBefore?.doubleValue ?? privateData.fields?.balanceBefore?.integerValue ?? 0);
+  const balanceAfter = Number(privateData.fields?.balanceAfter?.doubleValue ?? privateData.fields?.balanceAfter?.integerValue ?? 0);
+  const whatsapp = privateData.fields?.whatsapp?.stringValue || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
+  const whatsappLink = privateData.fields?.whatsappLink?.stringValue || https://wa.me/;
+  const webuid = privateData.fields?.webuid?.stringValue || "ØŸ";
+  const statusRaw = publicData.fields?.status?.stringValue || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
+  const statusHuman = typeof statusRaw === "string" ? statusRaw.replace(/_/g, " ") : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©";
+  return ğŸ”” **\n\n\nğŸ“¦ *Ø§Ù„Ø­Ø§Ù„Ø©:*   \n\n\u200FğŸ†” *ÙƒÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨:* \${orderId}\\n  \nğŸ® *Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨:* \${playerId}\\n  \nğŸ *Ø§Ù„Ø¹Ø±ÙˆØ¶:*\n\n  \nğŸ‘¤ *Ø§Ù„Ø§Ø³Ù…:* \n  \nğŸ’° *Ø§Ù„Ø±ØµÙŠØ¯:*  â† \n  \nğŸ§¾ *Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„:* \${webuid}\\n  \nğŸ“± *ÙˆØ§ØªØ³Ø§Ø¨:* ;
+}
@@
-async function computeRefundInfo(orderId, FIRESTORE, accessToken) {
-  const [pubRes, privRes] = await Promise.all([
-    fetch(${FIRESTORE}/orders//public/main, { headers: { Authorization: Bearer  } }),
-    fetch(${FIRESTORE}/orders//private/main, { headers: { Authorization: Bearer  } }),
-  ]);
-
-  if (!pubRes.ok || !privRes.ok) return { refundable: false };
-
-  const pub = await pubRes.json();
-  const priv = await privRes.json();
-
-  const alreadyRefunded = !!priv?.fields?.refundIssued?.booleanValue;
-  const webuid = priv?.fields?.webuid?.stringValue;
-
-  // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ÙØ¶Ù‘Ù„: total Ù…Ù† public
-  let totalRaw = pub?.fields?.total?.doubleValue ?? pub?.fields?.total?.stringValue;
-  let total = Number(totalRaw);
-  if (!Number.isFinite(total)) total = NaN;
-
-  // Ø§Ø­ØªÙŠØ§Ø·ÙŠÙ‹Ø§: ÙØ±Ù‚ Ø§Ù„Ø±ØµÙŠØ¯
-  const before = Number(priv?.fields?.balanceBefore?.doubleValue ?? priv?.fields?.balanceBefore?.integerValue ?? NaN);
-  const after  = Number(priv?.fields?.balanceAfter?.doubleValue  ?? priv?.fields?.balanceAfter?.integerValue  ?? NaN);
-  const diff = Number.isFinite(before) && Number.isFinite(after) ? Math.max(0, before - after) : NaN;
-
-  const refundAmount = Number.isFinite(total) ? total : (Number.isFinite(diff) ? diff : 0);
-
-  return {
-    refundable: !!webuid && refundAmount > 0 && !alreadyRefunded,
-    webuid: webuid || null,
-    refundAmount,
-    alreadyRefunded
-  };
-}
+async function computeRefundInfo(orderId, FIRESTORE, accessToken) {
+  // Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹
+  try {
+    const { entry } = await fetchOrderEntry(FIRESTORE, accessToken, orderId);
+    if (entry) {
+      const pub = entry.public?.mapValue?.fields || {};
+      const priv = entry.private?.mapValue?.fields || {};
+      const alreadyRefunded = priv.refunded?.booleanValue === true || priv.refundIssued?.booleanValue === true;
+      const webuid = priv.webuid?.stringValue;
+      let totalRaw = pub.total?.doubleValue ?? pub.total?.stringValue;
+      let total = Number(totalRaw);
+      if (!Number.isFinite(total)) total = NaN;
+      const before = Number(priv.balanceBefore?.doubleValue ?? priv.balanceBefore?.integerValue ?? NaN);
+      const after  = Number(priv.balanceAfter?.doubleValue  ?? priv.balanceAfter?.integerValue  ?? NaN);
+      const diff = Number.isFinite(before) && Number.isFinite(after) ? Math.max(0, before - after) : NaN;
+      const refundAmount = Number.isFinite(total) ? total : (Number.isFinite(diff) ? diff : 0);
+      return { refundable: !!webuid && refundAmount > 0 && !alreadyRefunded, webuid: webuid || null, refundAmount, alreadyRefunded };
+    }
+  } catch {}
+
+  // ØªÙˆØ§ÙÙ‚ÙŠÙ‹Ø§: Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…
+  const [pubRes, privRes] = await Promise.all([
+    fetch(${FIRESTORE}/orders//public/main, { headers: { Authorization: Bearer  } }),
+    fetch(${FIRESTORE}/orders//private/main, { headers: { Authorization: Bearer  } }),
+  ]);
+  if (!pubRes.ok || !privRes.ok) return { refundable: false };
+  const pub = await pubRes.json();
+  const priv = await privRes.json();
+  const alreadyRefunded = !!priv?.fields?.refundIssued?.booleanValue;
+  const webuid = priv?.fields?.webuid?.stringValue;
+  let totalRaw = pub?.fields?.total?.doubleValue ?? pub?.fields?.total?.stringValue;
+  let total = Number(totalRaw);
+  if (!Number.isFinite(total)) total = NaN;
+  const before = Number(priv?.fields?.balanceBefore?.doubleValue ?? priv?.fields?.balanceBefore?.integerValue ?? NaN);
+  const after  = Number(priv?.fields?.balanceAfter?.doubleValue  ?? priv?.fields?.balanceAfter?.integerValue  ?? NaN);
+  const diff = Number.isFinite(before) && Number.isFinite(after) ? Math.max(0, before - after) : NaN;
+  const refundAmount = Number.isFinite(total) ? total : (Number.isFinite(diff) ? diff : 0);
+  return { refundable: !!webuid && refundAmount > 0 && !alreadyRefunded, webuid: webuid || null, refundAmount, alreadyRefunded };
+}
*** End Patch
